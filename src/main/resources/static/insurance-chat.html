<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Insurance AI Chat POC - v1.3</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f7fa;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: #12412A;
      padding: 15px 20px;
      color: white;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 20px;
      font-weight: 500;
    }

    .chat-container {
      flex: 1;
      max-width: 900px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      background: white;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .message {
      display: flex;
      gap: 10px;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      justify-content: flex-end;
    }

    .message-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .message.user .message-bubble {
      background: #667eea;
      color: white;
    }

    .message.assistant .message-bubble {
      background: #f1f3f5;
      color: #1a1a1a;
    }

    .message-meta {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
    }

    .tools-used {
      display: inline-flex;
      gap: 4px;
      margin-left: 8px;
    }

    .tool-badge {
      background: #e3f2fd;
      color: #1976d2;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
    }

    .input-container {
      border-top: 1px solid #e0e0e0;
      padding: 20px;
      background: white;
    }

    .input-wrapper {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    .input-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .file-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .file-tag {
      background: #e8e8e8;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .file-remove {
      cursor: pointer;
      color: #999;
      font-weight: bold;
    }

    .message-input {
      flex: 1;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      resize: none;
      font-family: inherit;
    }

    .message-input:focus {
      border-color: #667eea;
    }

    .button-group {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .send-btn {
      background: #667eea;
      color: white;
    }

    .send-btn:hover:not(:disabled) {
      background: #5a67d8;
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .file-btn {
      background: #f1f3f5;
      color: #495057;
      position: relative;  /* Contains the absolute-positioned file input */
      overflow: hidden;  /* Ensure input doesn't escape */
    }

    .file-btn:hover {
      background: #e9ecef;
    }

    .file-input {
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .loading {
      display: flex;
      gap: 4px;
      padding: 20px;
      justify-content: center;
    }

    .loading-dot {
      width: 8px;
      height: 8px;
      background: #667eea;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .loading-dot:nth-child(1) { animation-delay: -0.32s; }
    .loading-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% {
        transform: scale(0);
      }
      40% {
        transform: scale(1.0);
      }
    }

    .error-message {
      background: #fee;
      color: #c00;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 20px;
      font-size: 14px;
    }

    .welcome-message {
      text-align: center;
      color: #999;
      padding: 40px;
      font-size: 14px;
    }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
  const { useState, useEffect, useRef } = React;

  // Generate a conversation ID (simple UUID v4)
  const generateConversationId = () => {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  };

  function ChatApp() {
    const [messages, setMessages] = useState([]);
    const [inputText, setInputText] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState(null);
    const [conversationId] = useState(generateConversationId());
    const [selectedFiles, setSelectedFiles] = useState([]);
    const messagesEndRef = useRef(null);
    const fileInputRef = useRef(null);

    const scrollToBottom = () => {
      messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    };

    useEffect(() => {
      scrollToBottom();
    }, [messages]);

    const handleFileSelect = (e) => {
      const files = Array.from(e.target.files);
      setSelectedFiles(prev => [...prev, ...files]);
      // Reset file input
      e.target.value = '';
    };

    const removeFile = (index) => {
      setSelectedFiles(prev => prev.filter((_, i) => i !== index));
    };

    const sendMessage = async () => {
      if (!inputText.trim() && selectedFiles.length === 0) return;
      if (isLoading) return;

      const userMessage = inputText.trim();
      const files = [...selectedFiles];

      // Add user message to chat
      if (userMessage || files.length > 0) {
        const userMsg = {
          role: 'user',
          content: userMessage || 'Uploaded ' + files.length + ' file(s)',
          files: files.map(f => f.name),
          timestamp: new Date().toISOString()
        };
        setMessages(prev => [...prev, userMsg]);
      }

      // Clear input and files
      setInputText('');
      setSelectedFiles([]);
      setError(null);
      setIsLoading(true);

      try {
        // Prepare form data
        const formData = new FormData();
        formData.append('message', userMessage || 'Please analyze the uploaded files');
        formData.append('conversationId', conversationId);

        // Add files if any
        files.forEach(file => {
          formData.append('files', file);
        });

        // Send to backend
        const response = await fetch('/api/chat/message', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.status === 'success') {
          // Add assistant response
          const assistantMsg = {
            role: 'assistant',
            content: data.response,
            toolsUsed: data.toolsUsed || [],
            timestamp: data.timestamp,
            processingTime: data.processingTimeMs
          };
          setMessages(prev => [...prev, assistantMsg]);
        } else {
          // Handle error response
          setError(data.error?.message || 'An error occurred');
        }
      } catch (err) {
        console.error('Error sending message:', err);
        setError('Failed to send message. Please check if the backend is running.');
      } finally {
        setIsLoading(false);
      }
    };

    const handleKeyPress = (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    };

    return (
            <React.Fragment>
              <div className="header">
                <h1>🤖 Insurance AI Chat - POC v1.3</h1>
              </div>

              <div className="chat-container">
                <div className="messages-container">
                  {messages.length === 0 && (
                          <div className="welcome-message">
                            <h2>Welcome to Insurance Chat!</h2>
                            <p>Start a conversation or upload files (PDF/images) for analysis</p>
                            <p>Available tools: PDF analysis, Image analysis, Email sending</p>
                          </div>
                  )}

                  {messages.map((msg, index) => (
                          <div key={index} className={`message ${msg.role}`}>
                            <div>
                              <div className="message-bubble">
                                {msg.content}
                                {msg.files && msg.files.length > 0 && (
                                        <div style={{marginTop: '8px', fontSize: '12px', opacity: 0.8}}>
                                          📎 Files: {msg.files.join(', ')}
                                        </div>
                                )}
                              </div>
                              {msg.role === 'assistant' && (
                                      <div className="message-meta">
                                        {msg.processingTime && `${msg.processingTime}ms`}
                                        {msg.toolsUsed && msg.toolsUsed.length > 0 && (
                                                <span className="tools-used">
                                                        {msg.toolsUsed.map((tool, i) => (
                                                                <span key={i} className="tool-badge">{tool}</span>
                                                        ))}
                                                    </span>
                                        )}
                                      </div>
                              )}
                            </div>
                          </div>
                  ))}

                  {isLoading && (
                          <div className="loading">
                            <div className="loading-dot"></div>
                            <div className="loading-dot"></div>
                            <div className="loading-dot"></div>
                          </div>
                  )}

                  {error && (
                          <div className="error-message">
                            ⚠️ {error}
                          </div>
                  )}

                  <div ref={messagesEndRef} />
                </div>

                <div className="input-container">
                  <div className="input-wrapper">
                    <div className="input-group">
                      {selectedFiles.length > 0 && (
                              <div className="file-preview">
                                {selectedFiles.map((file, index) => (
                                        <div key={index} className="file-tag">
                                          📄 {file.name}
                                          <span className="file-remove" onClick={() => removeFile(index)}>✕</span>
                                        </div>
                                ))}
                              </div>
                      )}
                      <textarea
                              className="message-input"
                              value={inputText}
                              onChange={(e) => setInputText(e.target.value)}
                              onKeyPress={handleKeyPress}
                              placeholder="Type your message... (Press Enter to send)"
                              rows="1"
                              disabled={isLoading}
                      />
                    </div>
                    <div className="button-group">
                      <button className="btn file-btn">
                        📎 Files
                        <input
                                type="file"
                                className="file-input"
                                ref={fileInputRef}
                                onChange={handleFileSelect}
                                multiple
                                accept=".pdf,image/*"
                                disabled={isLoading}
                        />
                      </button>
                      <button
                              className="btn send-btn"
                              onClick={sendMessage}
                              disabled={isLoading || (!inputText.trim() && selectedFiles.length === 0)}
                      >
                        Send
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </React.Fragment>
    );
  }

  // Render the app
  ReactDOM.render(<ChatApp />, document.getElementById('root'));
</script>
</body>
</html>
</html>