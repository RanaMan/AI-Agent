files:
  # System limits optimization
  "/etc/security/limits.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      # Increase limits for Java applications
      * soft nofile 65536
      * hard nofile 65536
      * soft nproc 32768
      * hard nproc 32768
      * soft memlock unlimited
      * hard memlock unlimited
      
      # Specific limits for webapp user
      webapp soft nofile 65536
      webapp hard nofile 65536
      webapp soft nproc 32768
      webapp hard nproc 32768

  # Kernel parameter tuning
  "/etc/sysctl.d/99-java-performance.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      # Network optimizations
      net.core.rmem_max = 134217728
      net.core.wmem_max = 134217728
      net.ipv4.tcp_rmem = 4096 87380 134217728
      net.ipv4.tcp_wmem = 4096 65536 134217728
      net.core.netdev_max_backlog = 5000
      net.ipv4.tcp_congestion_control = bbr
      net.ipv4.tcp_notsent_lowat = 16384
      net.ipv4.tcp_fastopen = 3
      
      # Connection handling
      net.ipv4.tcp_fin_timeout = 15
      net.ipv4.tcp_keepalive_time = 300
      net.ipv4.tcp_keepalive_intvl = 30
      net.ipv4.tcp_keepalive_probes = 3
      net.ipv4.tcp_tw_reuse = 1
      net.ipv4.ip_local_port_range = 1024 65535
      net.ipv4.tcp_max_syn_backlog = 8192
      net.core.somaxconn = 8192
      
      # Memory optimizations
      vm.swappiness = 1
      vm.overcommit_memory = 1
      vm.max_map_count = 262144
      vm.dirty_ratio = 15
      vm.dirty_background_ratio = 5
      
      # File system optimizations
      fs.file-max = 2097152
      fs.nr_open = 1048576

  # Swap file configuration for memory pressure handling
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/03_configure_swap.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Create swap file if it doesn't exist (512MB for t3.micro)
      SWAPFILE=/var/swapfile
      SWAPSIZE=512
      
      if [ ! -f $SWAPFILE ]; then
        echo "Creating ${SWAPSIZE}MB swap file..."
        dd if=/dev/zero of=$SWAPFILE bs=1M count=$SWAPSIZE
        chmod 600 $SWAPFILE
        mkswap $SWAPFILE
        swapon $SWAPFILE
        echo "$SWAPFILE none swap sw 0 0" >> /etc/fstab
      fi
      
      # Verify swap is active
      swapon -s

  # CPU governor optimization
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/04_optimize_cpu.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Set CPU governor to performance mode
      for cpu in /sys/devices/system/cpu/cpu[0-9]*; do
        if [ -f "$cpu/cpufreq/scaling_governor" ]; then
          echo "performance" > "$cpu/cpufreq/scaling_governor"
        fi
      done
      
      # Disable CPU frequency scaling
      if command -v cpupower &> /dev/null; then
        cpupower frequency-set -g performance
      fi

  # Disk I/O optimization
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/05_optimize_disk.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Optimize disk scheduler for SSDs
      for disk in /sys/block/nvme*n* /sys/block/xvd*; do
        if [ -d "$disk" ]; then
          echo "noop" > "$disk/queue/scheduler"
          echo "256" > "$disk/queue/nr_requests"
          echo "0" > "$disk/queue/rotational"
        fi
      done
      
      # Enable filesystem optimizations
      mount -o remount,noatime,nodiratime /

commands:
  01_apply_sysctl:
    command: "sysctl -p /etc/sysctl.d/99-java-performance.conf"
  
  02_disable_transparent_hugepages:
    command: |
      echo never > /sys/kernel/mm/transparent_hugepage/enabled
      echo never > /sys/kernel/mm/transparent_hugepage/defrag
  
  03_install_performance_tools:
    command: "yum install -y sysstat dstat iftop -q"

container_commands:
  01_optimize_system:
    command: |
      # Apply ulimits
      ulimit -n 65536
      ulimit -u 32768
      
      # Log system optimization status
      echo "System optimization completed at $(date)" >> /var/log/eb-app/optimization.log
      sysctl -a | grep -E "net.core|vm.swap|fs.file-max" >> /var/log/eb-app/optimization.log