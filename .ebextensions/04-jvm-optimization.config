option_settings:
  # JVM Performance Optimization for t3.micro (1GB RAM)
  aws:elasticbeanstalk:container:java:
    # Heap memory settings (50% of system RAM for heap)
    Xmx: 512m
    Xms: 512m
    # JVM optimization flags
    JVM Options: >
      -XX:+UseG1GC
      -XX:MaxGCPauseMillis=200
      -XX:ParallelGCThreads=2
      -XX:ConcGCThreads=1
      -XX:InitiatingHeapOccupancyPercent=70
      -XX:+UseStringDeduplication
      -XX:+OptimizeStringConcat
      -XX:+UseCompressedOops
      -XX:+UseCompressedClassPointers
      -XX:MaxMetaspaceSize=128m
      -XX:ReservedCodeCacheSize=64m
      -XX:+TieredCompilation
      -XX:TieredStopAtLevel=1
      -Djava.security.egd=file:/dev/./urandom
      -Djava.awt.headless=true
      -Dfile.encoding=UTF-8
      -XX:+HeapDumpOnOutOfMemoryError
      -XX:HeapDumpPath=/var/log/eb-app
      -XX:ErrorFile=/var/log/eb-app/hs_err_pid%p.log
      -XX:+ExitOnOutOfMemoryError
      -Xlog:gc*:file=/var/log/eb-app/gc.log:time,uptime:filecount=5,filesize=10M

  # Application-specific JVM settings
  aws:elasticbeanstalk:application:environment:
    # Garbage collection logging
    JAVA_TOOL_OPTIONS: "-XX:+PrintFlagsFinal -XX:+PrintCommandLineFlags"
    # LangChain4j specific optimizations
    LANGCHAIN4J_THREAD_POOL_SIZE: "4"
    LANGCHAIN4J_CONNECTION_TIMEOUT: "30000"
    LANGCHAIN4J_REQUEST_TIMEOUT: "60000"

files:
  # JVM monitoring script
  "/opt/elasticbeanstalk/tasks/bundlelogs.d/gc-logs.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      /var/log/eb-app/gc.log*
      /var/log/eb-app/hs_err_pid*.log

  # Custom JVM tuning script
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_tune_jvm.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # Calculate optimal JVM settings based on instance memory
      TOTAL_MEM=$(free -m | awk '/^Mem:/{print $2}')
      HEAP_SIZE=$((TOTAL_MEM * 50 / 100))
      METASPACE_SIZE=$((TOTAL_MEM * 12 / 100))
      
      echo "Total Memory: ${TOTAL_MEM}MB"
      echo "Allocated Heap: ${HEAP_SIZE}MB"
      echo "Allocated Metaspace: ${METASPACE_SIZE}MB"
      
      # Update kernel parameters for better Java performance
      echo "Optimizing kernel parameters for Java..."
      sysctl -w vm.swappiness=1
      sysctl -w vm.max_map_count=262144
      sysctl -w net.core.somaxconn=1024
      sysctl -w net.ipv4.tcp_max_syn_backlog=2048